{"remainingRequest":"D:\\新建文件夹\\zhonghua\\myapp\\node_modules\\babel-loader\\lib\\index.js!D:\\新建文件夹\\zhonghua\\myapp\\node_modules\\vue-loader-v16\\dist\\templateLoader.js??ref--6!D:\\新建文件夹\\zhonghua\\myapp\\node_modules\\cache-loader\\dist\\cjs.js??ref--1-0!D:\\新建文件夹\\zhonghua\\myapp\\node_modules\\vue-loader-v16\\dist\\index.js??ref--1-1!D:\\新建文件夹\\zhonghua\\myapp\\src\\components\\MobileCamera.vue?vue&type=template&id=c0ba71d2&scoped=true","dependencies":[{"path":"D:\\新建文件夹\\zhonghua\\myapp\\src\\components\\MobileCamera.vue","mtime":1744027380719},{"path":"D:\\新建文件夹\\zhonghua\\myapp\\babel.config.js","mtime":1744027369070},{"path":"D:\\新建文件夹\\zhonghua\\myapp\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1744027371138},{"path":"D:\\新建文件夹\\zhonghua\\myapp\\node_modules\\babel-loader\\lib\\index.js","mtime":1744027370914},{"path":"D:\\新建文件夹\\zhonghua\\myapp\\node_modules\\vue-loader-v16\\dist\\templateLoader.js","mtime":1744027379696},{"path":"D:\\新建文件夹\\zhonghua\\myapp\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1744027371138},{"path":"D:\\新建文件夹\\zhonghua\\myapp\\node_modules\\vue-loader-v16\\dist\\index.js","mtime":1744027379691}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0IHsgY3JlYXRlRWxlbWVudFZOb2RlIGFzIF9jcmVhdGVFbGVtZW50Vk5vZGUsIHRvRGlzcGxheVN0cmluZyBhcyBfdG9EaXNwbGF5U3RyaW5nLCBvcGVuQmxvY2sgYXMgX29wZW5CbG9jaywgY3JlYXRlRWxlbWVudEJsb2NrIGFzIF9jcmVhdGVFbGVtZW50QmxvY2ssIGNyZWF0ZUNvbW1lbnRWTm9kZSBhcyBfY3JlYXRlQ29tbWVudFZOb2RlLCBwdXNoU2NvcGVJZCBhcyBfcHVzaFNjb3BlSWQsIHBvcFNjb3BlSWQgYXMgX3BvcFNjb3BlSWQgfSBmcm9tICJ2dWUiOwoKdmFyIF93aXRoU2NvcGVJZCA9IGZ1bmN0aW9uIF93aXRoU2NvcGVJZChuKSB7CiAgcmV0dXJuIF9wdXNoU2NvcGVJZCgiZGF0YS12LWMwYmE3MWQyIiksIG4gPSBuKCksIF9wb3BTY29wZUlkKCksIG47Cn07Cgp2YXIgX2hvaXN0ZWRfMSA9IHsKICAiY2xhc3MiOiAiY2FtZXJhLWNvbnRhaW5lciIKfTsKdmFyIF9ob2lzdGVkXzIgPSB7CiAgImNsYXNzIjogInZpZGVvLXdyYXBwZXIiCn07CnZhciBfaG9pc3RlZF8zID0gewogIHJlZjogInZpZGVvRWxlbWVudCIsCiAgYXV0b3BsYXk6ICIiLAogIHBsYXlzaW5saW5lOiAiIgp9Owp2YXIgX2hvaXN0ZWRfNCA9IHsKICBrZXk6IDAsCiAgImNsYXNzIjogInJlY29nbml0aW9uLXJlc3VsdCIKfTsKdmFyIF9ob2lzdGVkXzUgPSB7CiAgcmVmOiAiY2FudmFzRWxlbWVudCIsCiAgc3R5bGU6IHsKICAgICJkaXNwbGF5IjogIm5vbmUiCiAgfQp9Owp2YXIgX2hvaXN0ZWRfNiA9IHsKICAiY2xhc3MiOiAiY29udHJvbHMiCn07CmV4cG9ydCBmdW5jdGlvbiByZW5kZXIoX2N0eCwgX2NhY2hlLCAkcHJvcHMsICRzZXR1cCwgJGRhdGEsICRvcHRpb25zKSB7CiAgcmV0dXJuIF9vcGVuQmxvY2soKSwgX2NyZWF0ZUVsZW1lbnRCbG9jaygiZGl2IiwgX2hvaXN0ZWRfMSwgW19jcmVhdGVFbGVtZW50Vk5vZGUoImRpdiIsIF9ob2lzdGVkXzIsIFtfY3JlYXRlRWxlbWVudFZOb2RlKCJ2aWRlbyIsIF9ob2lzdGVkXzMsIG51bGwsIDUxMgogIC8qIE5FRURfUEFUQ0ggKi8KICApLCAkZGF0YS5yZWNvZ25pdGlvblRleHQgPyAoX29wZW5CbG9jaygpLCBfY3JlYXRlRWxlbWVudEJsb2NrKCJkaXYiLCBfaG9pc3RlZF80LCBfdG9EaXNwbGF5U3RyaW5nKCRkYXRhLnJlY29nbml0aW9uVGV4dCksIDEKICAvKiBURVhUICovCiAgKSkgOiBfY3JlYXRlQ29tbWVudFZOb2RlKCJ2LWlmIiwgdHJ1ZSldKSwgX2NyZWF0ZUVsZW1lbnRWTm9kZSgiY2FudmFzIiwgX2hvaXN0ZWRfNSwgbnVsbCwgNTEyCiAgLyogTkVFRF9QQVRDSCAqLwogICksIF9jcmVhdGVFbGVtZW50Vk5vZGUoImRpdiIsIF9ob2lzdGVkXzYsIFtfY3JlYXRlRWxlbWVudFZOb2RlKCJidXR0b24iLCB7CiAgICBvbkNsaWNrOiBfY2FjaGVbMF0gfHwgKF9jYWNoZVswXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuICRvcHRpb25zLnN0YXJ0Q2FtZXJhICYmICRvcHRpb25zLnN0YXJ0Q2FtZXJhLmFwcGx5KCRvcHRpb25zLCBhcmd1bWVudHMpOwogICAgfSkKICB9LCAi5byA5ZCv5pGE5YOP5aS0IiksIF9jcmVhdGVFbGVtZW50Vk5vZGUoImJ1dHRvbiIsIHsKICAgIG9uQ2xpY2s6IF9jYWNoZVsxXSB8fCAoX2NhY2hlWzFdID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gJG9wdGlvbnMuc3RvcENhbWVyYSAmJiAkb3B0aW9ucy5zdG9wQ2FtZXJhLmFwcGx5KCRvcHRpb25zLCBhcmd1bWVudHMpOwogICAgfSkKICB9LCAi5YWz6Zet5pGE5YOP5aS0IildKV0pOwp9"},{"version":3,"sources":["D:\\新建文件夹\\zhonghua\\myapp\\src\\components\\MobileCamera.vue"],"names":[],"mappings":";;;;;;;AACO,WAAM;;;AACJ,WAAM;;;AACF,EAAA,GAAG,EAAC,c;AAAe,EAAA,QAAQ,EAAR,E;AAAS,EAAA,WAAW,EAAX;;;;AAC9B,WAAM;;;AAIL,EAAA,GAAG,EAAC,e;AAAgB,EAAA,KAAsB,EAAtB;AAAA,eAAA;AAAA;;;AACvB,WAAM;;;uBARb,mBAAA,CAYM,KAZN,EAAA,UAAA,EAYM,CAXJ,mBAAA,CAKM,KALN,EAAA,UAAA,EAKM,CAJJ,mBAAA,CAAuD,OAAvD,EAAA,UAAA,EAAuD,IAAvD,EAAuD;AAAA;AAAvD,GAII,EAHkC,KAAA,CAAA,e,kBAAtC,mBAAA,CAEM,KAFN,EAAA,UAAA,EAEM,gBAAA,CADD,KAAA,CAAA,eACC,CAFN,EACoB;AAAA;AADpB,G,qCAGI,CALN,CAWI,EALJ,mBAAA,CAA4D,QAA5D,EAAA,UAAA,EAA4D,IAA5D,EAA4D;AAAA;AAA5D,GAKI,EAJJ,mBAAA,CAGM,KAHN,EAAA,UAAA,EAGM,CAFJ,mBAAA,CAA2C,QAA3C,EAA2C;AAAlC,IAAA,OAAK,EAAA,MAAA,CAAA,CAAA,CAAA,KAAA,MAAA,CAAA,CAAA,CAAA,GAAA;AAAA,aAAE,QAAA,CAAA,WAAA,IAAA,QAAA,CAAA,WAAA,OAAA,QAAA,YAAF;AAAA,KAAA;AAA6B,GAA3C,EAA6B,OAA7B,CAEI,EADJ,mBAAA,CAA0C,QAA1C,EAA0C;AAAjC,IAAA,OAAK,EAAA,MAAA,CAAA,CAAA,CAAA,KAAA,MAAA,CAAA,CAAA,CAAA,GAAA;AAAA,aAAE,QAAA,CAAA,UAAA,IAAA,QAAA,CAAA,UAAA,OAAA,QAAA,YAAF;AAAA,KAAA;AAA4B,GAA1C,EAA4B,OAA5B,CACI,CAHN,CAII,CAZN,C","sourcesContent":["<template>\r\n  <div class=\"camera-container\">\r\n    <div class=\"video-wrapper\">\r\n      <video ref=\"videoElement\" autoplay playsinline></video>\r\n      <div class=\"recognition-result\" v-if=\"recognitionText\">\r\n        {{ recognitionText }}\r\n      </div>\r\n    </div>\r\n    <canvas ref=\"canvasElement\" style=\"display: none;\"></canvas>\r\n    <div class=\"controls\">\r\n      <button @click=\"startCamera\">开启摄像头</button>\r\n      <button @click=\"stopCamera\">关闭摄像头</button>\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nimport io from 'socket.io-client'\r\nimport axios from 'axios'\r\n\r\nexport default {\r\n  name: 'MobileCamera',\r\n  data() {\r\n    return {\r\n      stream: null,\r\n      socket: null,\r\n      scanning: false,\r\n      recognitionText: '',\r\n      recognitionInterval: null,\r\n      videoConstraints: {\r\n        facingMode: { exact: \"environment\" }, // 使用后置摄像头\r\n        width: { ideal: 1280 },\r\n        height: { ideal: 720 }\r\n      },\r\n      streamingInterval: null\r\n    }\r\n  },\r\n  methods: {\r\n    async startCamera() {\r\n      try {\r\n        // 先测试 API 连接\r\n        console.log('=== Testing API connection ===');\r\n        const serverUrl = window.location.hostname === 'localhost' ? \r\n          'http://localhost:3000' : `http://${window.location.hostname}:3000`;\r\n        \r\n        try {\r\n          console.log('Testing endpoint:', `${serverUrl}/api/test`);\r\n          const testResponse = await axios.get(`${serverUrl}/api/test`);\r\n          console.log('API test response:', testResponse.data);\r\n          \r\n          if (!testResponse.data.env.apiKey || !testResponse.data.env.apiUrl) {\r\n            throw new Error('API configuration is incomplete');\r\n          }\r\n        } catch (error) {\r\n          console.error('API test failed:', error);\r\n          alert('API 连接测试失败: ' + (error.response?.data?.message || error.message));\r\n          return;\r\n        }\r\n\r\n        // 继续原有的摄像头启动逻辑\r\n        console.log('Starting camera...');\r\n        this.stream = await navigator.mediaDevices.getUserMedia({\r\n          video: this.videoConstraints\r\n        });\r\n        this.$refs.videoElement.srcObject = this.stream;\r\n        \r\n        console.log('Starting streaming service...');\r\n        this.startStreaming();\r\n        \r\n        console.log('Starting recognition service...');\r\n        this.startRecognition();\r\n      } catch (error) {\r\n        console.error('Camera startup error:', error);\r\n        alert('无法访问摄像头: ' + error.message);\r\n      }\r\n    },\r\n    stopCamera() {\r\n      if (this.stream) {\r\n        this.stream.getTracks().forEach(track => track.stop());\r\n        this.$refs.videoElement.srcObject = null;\r\n        this.stream = null;\r\n      }\r\n      if (this.socket) {\r\n        this.socket.disconnect();\r\n        this.socket = null;\r\n      }\r\n      if (this.streamingInterval) {\r\n        clearInterval(this.streamingInterval);\r\n        this.streamingInterval = null;\r\n      }\r\n      if (this.recognitionInterval) {\r\n        clearInterval(this.recognitionInterval);\r\n        this.recognitionInterval = null;\r\n      }\r\n      this.recognitionText = '';\r\n    },\r\n    startStreaming() {\r\n      const serverUrl = window.location.hostname === 'localhost' \r\n        ? 'http://localhost:3000' \r\n        : `https://${window.location.hostname}`;\r\n      \r\n      this.socket = io(serverUrl, {\r\n        transports: ['websocket', 'polling'],\r\n        path: '/socket.io'\r\n      });\r\n\r\n      this.socket.on('connect', () => {\r\n        console.log('Connected to streaming server');\r\n      });\r\n\r\n      this.socket.on('disconnect', () => {\r\n        console.log('Disconnected from streaming server');\r\n      });\r\n\r\n      // 每隔一定时间发送视频帧\r\n      this.streamingInterval = setInterval(() => {\r\n        if (this.stream && this.socket && this.socket.connected) {\r\n          const canvas = this.$refs.canvasElement;\r\n          const video = this.$refs.videoElement;\r\n          const context = canvas.getContext('2d');\r\n          \r\n          canvas.width = video.videoWidth;\r\n          canvas.height = video.videoHeight;\r\n          context.drawImage(video, 0, 0, canvas.width, canvas.height);\r\n          \r\n          const imageData = canvas.toDataURL('image/jpeg', 0.5);\r\n          this.socket.emit('videoFrame', {\r\n            image: imageData,\r\n            recognitionText: this.recognitionText\r\n          });\r\n        }\r\n      }, 100);\r\n    },\r\n    startRecognition() {\r\n      console.log('=== Starting recognition service ===');\r\n      // 先发送一个测试图片\r\n      setTimeout(async () => {\r\n        try {\r\n          const testImageData = 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wAARCAAIAAoDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAb/xAAUEAEAAAAAAAAAAAAAAAAAAAAA/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAX/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwCdABmX/9k=';\r\n          \r\n          console.log('=== Sending test image ===');\r\n          const serverUrl = window.location.hostname === 'localhost' ? \r\n            'http://localhost:3000' : `http://${window.location.hostname}:3000`;\r\n          \r\n          const response = await axios.post(`${serverUrl}/api/recognize`, {\r\n            image: testImageData\r\n          }, {\r\n            headers: {\r\n              'Content-Type': 'application/json'\r\n            },\r\n            timeout: 30000\r\n          });\r\n          \r\n          console.log('Test image response:', response.data);\r\n        } catch (error) {\r\n          console.error('Test image recognition failed:', error);\r\n        }\r\n      }, 1000);\r\n\r\n      // 原有的识别逻辑\r\n      this.recognitionInterval = setInterval(async () => {\r\n        if (this.stream) {\r\n          try {\r\n            console.log('=== Capturing frame ===');\r\n            const canvas = this.$refs.canvasElement;\r\n            const video = this.$refs.videoElement;\r\n            const context = canvas.getContext('2d');\r\n            \r\n            // 设置较小的尺寸以减少数据量\r\n            canvas.width = 320;\r\n            canvas.height = 240;\r\n            context.drawImage(video, 0, 0, canvas.width, canvas.height);\r\n            \r\n            // 获取base64图片数据\r\n            const imageData = canvas.toDataURL('image/jpeg', 0.5);\r\n            console.log('Image captured:', {\r\n              size: imageData.length,\r\n              prefix: imageData.substring(0, 50) + '...'\r\n            });\r\n            \r\n            console.log('=== Sending request to server ===');\r\n            try {\r\n              const serverUrl = window.location.hostname === 'localhost' ? \r\n                'http://localhost:3000' : `http://${window.location.hostname}:3000`;\r\n              \r\n              console.log('Server URL:', serverUrl + '/api/recognize');\r\n              const response = await axios.post(serverUrl + '/api/recognize', {\r\n                image: imageData\r\n              }, {\r\n                headers: {\r\n                  'Content-Type': 'application/json'\r\n                },\r\n                timeout: 30000\r\n              });\r\n              \r\n              console.log('=== Server response ===');\r\n              console.log('Status:', response.status);\r\n              console.log('Headers:', response.headers);\r\n              console.log('Data:', response.data);\r\n              \r\n              if (response.data && response.data.description) {\r\n                console.log('=== Updating recognition text ===');\r\n                this.recognitionText = response.data.description;\r\n                \r\n                if (this.socket && this.socket.connected) {\r\n                  console.log('=== Broadcasting result ===');\r\n                  this.socket.emit('videoFrame', {\r\n                    image: imageData,\r\n                    recognitionText: this.recognitionText\r\n                  });\r\n                }\r\n              }\r\n            } catch (error) {\r\n              console.error('=== API Call Error ===');\r\n              console.error('Error type:', error.constructor.name);\r\n              console.error('Error message:', error.message);\r\n              if (error.response) {\r\n                console.error('Response status:', error.response.status);\r\n                console.error('Response data:', error.response.data);\r\n              } else if (error.request) {\r\n                console.error('No response received - possible network error');\r\n              }\r\n            }\r\n          } catch (error) {\r\n            console.error('=== Image Processing Error ===');\r\n            console.error('Error type:', error.constructor.name);\r\n            console.error('Error message:', error.message);\r\n          }\r\n        } else {\r\n          console.log('Stream not available');\r\n        }\r\n      }, 8000);\r\n    },\r\n    // 添加图片上传到图床的函数\r\n    async uploadToImageHost(imageData) {\r\n      // 这里需要实现实际的图片上传逻辑\r\n      // 可以使用第三方图床API，如七牛云、阿里云OSS等\r\n      // 返回上传后的图片URL\r\n      try {\r\n        const formData = new FormData();\r\n        // 将base64转换为文件\r\n        const blob = await fetch(imageData).then(r => r.blob());\r\n        formData.append('image', blob);\r\n        \r\n        // 这里替换为实际的图床上传API\r\n        const response = await axios.post('YOUR_IMAGE_HOST_API', formData, {\r\n          headers: {\r\n            'Content-Type': 'multipart/form-data'\r\n          }\r\n        });\r\n        \r\n        return response.data.url; // 返回上传后的图片URL\r\n      } catch (error) {\r\n        console.error('Error uploading image:', error);\r\n        throw error;\r\n      }\r\n    }\r\n  },\r\n  beforeDestroy() {\r\n    this.stopCamera();\r\n  }\r\n}\r\n</script>\r\n\r\n<style scoped>\r\n.camera-container {\r\n  width: 100%;\r\n  max-width: 800px;\r\n  margin: 0 auto;\r\n  padding: 20px;\r\n}\r\n\r\n.video-wrapper {\r\n  position: relative;\r\n  width: 100%;\r\n  max-width: 640px;\r\n  margin: 0 auto;\r\n}\r\n\r\nvideo {\r\n  width: 100%;\r\n  display: block;\r\n  border: 1px solid #ccc;\r\n  border-radius: 8px;\r\n}\r\n\r\n.recognition-result {\r\n  position: absolute;\r\n  bottom: 20px;\r\n  left: 20px;\r\n  right: 20px;\r\n  background: rgba(0, 0, 0, 0.7);\r\n  color: white;\r\n  padding: 10px;\r\n  border-radius: 4px;\r\n  font-size: 14px;\r\n  line-height: 1.4;\r\n}\r\n\r\n.controls {\r\n  margin-top: 20px;\r\n  text-align: center;\r\n}\r\n\r\nbutton {\r\n  margin: 0 10px;\r\n  padding: 10px 20px;\r\n  background-color: #4CAF50;\r\n  color: white;\r\n  border: none;\r\n  border-radius: 4px;\r\n  cursor: pointer;\r\n}\r\n\r\nbutton:hover {\r\n  background-color: #45a049;\r\n}\r\n</style> "],"sourceRoot":""}]}